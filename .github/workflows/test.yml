name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

permissions:
  contents: read

jobs:
  docker:
    name: "ðŸ³ Ð¡Ð±Ð¾Ñ€ÐºÐ° Docker"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: "ðŸ”¨ Ð¡Ð±Ð¾Ñ€ÐºÐ° Docker Ð¾Ð±Ñ€Ð°Ð·Ð°"
        id: docker-build
        run: |
          set -o pipefail
          echo "## ðŸ³ Ð¡Ð±Ð¾Ñ€ÐºÐ° Docker Ð¾Ð±Ñ€Ð°Ð·Ð°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if docker build -t mireapprove:test . 2>&1 | tee docker_output.txt; then
            echo "âœ… **Docker Ð¾Ð±Ñ€Ð°Ð· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð±Ñ€Ð°Ð½!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            docker images mireapprove:test --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸ Docker Ð¾Ð±Ñ€Ð°Ð·Ð°!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Ð›Ð¾Ð³ Ð¾ÑˆÐ¸Ð±ÐºÐ¸:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -30 docker_output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ’¡ ÐšÐ°Ðº Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ:" >> $GITHUB_STEP_SUMMARY
            echo "1. Ð¡Ð¾Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¾Ð±Ñ€Ð°Ð· Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾: \`docker build -t mireapprove:test .\`" >> $GITHUB_STEP_SUMMARY
            echo "2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Dockerfile Ð½Ð° ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸" >> $GITHUB_STEP_SUMMARY
            echo "3. Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ Ñ‡Ñ‚Ð¾ Ð²ÑÐµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: "âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker Ð¾Ð±Ñ€Ð°Ð·Ð°"
        run: docker images mireapprove:test

